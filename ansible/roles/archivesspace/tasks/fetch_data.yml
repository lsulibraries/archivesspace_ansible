---
- set_fact:
    fetch: "{{ fetch_data}}"

- name: get pip
  apt:
    name: python-pip
  when: fetch == True

- name: get mysql lib
  apt:
    name: python-mysqldb
  when: fetch == True

- name: get aws cli
  pip:
    name: awscli
  when: fetch == True

- name: make aws config dir
  file:
    path: /root/.aws
    state: directory
  when: fetch == True

- name: configure aws cli
  template:
    src: templates/awsconfig.j2
    dest: /root/.aws/config
  when: fetch == True

- name: get latest db from s3
  command: "aws s3 cp s3://{{ bucket }}/latest/daily_archivesspace.sql.gz /opt/"
  when: fetch == True

- name: import db
  mysql_db:
    target: /opt/daily_archivesspace.sql.gz
    db: archivesspace
    config_file: /root/.my.cnf
    state: import
  when: fetch == True

- name: restart archivesspace
  service: 
    name: archivesspace
    state: restarted
    sleep: 30
  when: fetch == True
